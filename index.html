<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Minimalista + Google Sheets</title>

  <!-- 1. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- 3. React & ReactDOM & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    /* Leaflet map container override */
    .leaflet-container { z-index: 1; }
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Animation utilities */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel" data-presets="env,react,typescript">
    const { useState, useEffect, useRef, useCallback } = React;

    // ------------------------------------------------------------------
    // CONFIGURACIÓN: URL DE GOOGLE APPS SCRIPT
    // ------------------------------------------------------------------
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxCRkxrZfl_13X2A8wAm7QxJFgdtCi5WZ5ZUVt0KoZ_6HTnMgqd7Gz73EmYFjozxAo1/exec';

    // --- 2. ICONS ---
    const Icon = ({ children, className, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const PlusIcon = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
    const Edit2Icon = (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
    const Trash2Icon = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
    const PhoneIcon = (props) => <Icon {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></Icon>;
    const Building2Icon = (props) => <Icon {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></Icon>;
    const SearchIcon = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></Icon>;
    const MapPinIcon = (props) => <Icon {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></Icon>;
    const NavigationIcon = (props) => <Icon {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></Icon>;
    const XIcon = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
    const CrosshairIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></Icon>;
    const SaveIcon = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
    const AlertTriangleIcon = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;

    // --- 3. SERVICES & HELPERS ---
    const getErrorMessage = (error) => {
      if (!error) return 'Error desconocido';
      if (error instanceof Error) return error.message;
      if (typeof error === 'string') return error;
      if (typeof error === 'object') {
        const msg = error.message || error.error || error.description;
        if (msg && typeof msg === 'string') return msg;
        try { return JSON.stringify(error); } catch (e) {}
      }
      return "Error desconocido";
    };

    const checkUrl = () => {
      if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('INSERT_GOOGLE_SCRIPT_URL_HERE')) {
        throw new Error("⚠️ CONFIGURACIÓN REQUERIDA: URL de Google Apps Script no configurada.");
      }
    };

    const fetchClients = async () => {
      checkUrl();
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return result.data.map(item => ({
          ID: item.id,
          Nombre: item.nombre,
          Teléfono: item.telefono,
          Email: item.email,
          Empresa: item.empresa,
          Cédula: item.cedula,
          Dirección: item.direccion,
          Categoría: item.categoria,
          Estado: item.estado,
          Notas: item.notas,
          Lat: item.lat ? parseFloat(item.lat) : null,
          Lng: item.lng ? parseFloat(item.lng) : null
        }));
      } catch (error) {
        throw new Error(getErrorMessage(error));
      }
    };

    const saveClient = async (client) => {
      checkUrl();
      const payload = {
        action: client.ID ? 'update' : 'create',
        id: client.ID,
        data: {
          nombre: client.Nombre, telefono: client.Teléfono, email: client.Email,
          empresa: client.Empresa, cedula: client.Cédula, direccion: client.Dirección,
          categoria: client.Categoría, estado: client.Estado, notas: client.Notas,
          lat: client.Lat, lng: client.Lng
        }
      };
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return result;
      } catch (error) {
        throw new Error(getErrorMessage(error));
      }
    };

    const deleteClient = async (id) => {
      checkUrl();
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'delete', id: id })
        });
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return { status: 'success' };
      } catch (error) {
        throw new Error(getErrorMessage(error));
      }
    };

    // --- 4. MAP COMPONENT ---
    const MapComponent = ({ clients, tempLocation }) => {
      const mapRef = useRef(null);
      const mapContainerId = 'leaflet-map-container';
      const markersRef = useRef([]);
      const tempMarkerRef = useRef(null);

      useEffect(() => {
        if (typeof L === 'undefined') return;
        if (!mapRef.current) {
          const defaultCoords = [-32.522, -55.765]; 
          mapRef.current = L.map(mapContainerId).setView(defaultCoords, 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
          }).addTo(mapRef.current);
        }
        setTimeout(() => { mapRef.current?.invalidateSize(); }, 200);
      }, []);

      useEffect(() => {
        if (!mapRef.current || typeof L === 'undefined') return;
        markersRef.current.forEach(m => mapRef.current.removeLayer(m));
        markersRef.current = [];
        clients.forEach(client => {
          if (client.Lat && client.Lng) {
            const marker = L.marker([client.Lat, client.Lng])
              .addTo(mapRef.current)
              .bindPopup(`
                <div style="font-family: 'Inter', sans-serif; font-size: 14px; min-width: 160px;">
                  <b style="display:block; margin-bottom: 4px; font-size: 16px;">${client.Nombre}</b>
                  <div style="color: #475569; margin-bottom: 4px; font-size: 12px;">${client.Teléfono}</div>
                  <div style="color: #64748b; font-style: italic; margin-bottom: 10px; font-size: 12px;">${client.Dirección || ''}</div>
                  <a href="https://www.google.com/maps/dir/?api=1&destination=${client.Lat},${client.Lng}" target="_blank" 
                     style="display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%; background-color: #3b82f6; color: white; padding: 8px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 12px;">
                    <span>Cómo llegar</span>
                  </a>
                </div>
              `);
            markersRef.current.push(marker);
          }
        });
      }, [clients]);

      useEffect(() => {
        if (!mapRef.current || typeof L === 'undefined') return;
        if (tempLocation) {
          if (tempMarkerRef.current) mapRef.current.removeLayer(tempMarkerRef.current);
          tempMarkerRef.current = L.marker([tempLocation.lat, tempLocation.lng])
            .addTo(mapRef.current)
            .bindPopup("Ubicación Seleccionada")
            .openPopup();
          mapRef.current.setView([tempLocation.lat, tempLocation.lng], 16);
        } else if (tempMarkerRef.current) {
          mapRef.current.removeLayer(tempMarkerRef.current);
          tempMarkerRef.current = null;
        }
      }, [tempLocation]);

      if (typeof L === 'undefined') return <div className="w-full h-[500px] rounded-2xl shadow-lg border border-slate-200 mt-8 bg-slate-50 flex items-center justify-center text-slate-400">Cargando mapa...</div>;
      return <div id={mapContainerId} className="w-full h-[500px] rounded-2xl shadow-lg border border-slate-200 mt-8 z-0"></div>;
    };

    // --- 5. FORM COMPONENT ---
    const initialFormState = { Nombre: '', Teléfono: '', Email: '', Empresa: '', Cédula: '', Dirección: '', Categoría: 'Cliente', Estado: 'Activo', Notas: '', Lat: null, Lng: null };

    const ClientForm = ({ isOpen, onClose, onSubmit, initialData, onShowNotification }) => {
      const [formData, setFormData] = useState(initialFormState);
      const [loading, setLoading] = useState(false);
      const [locating, setLocating] = useState(false);

      useEffect(() => { if (isOpen) setFormData(initialData || initialFormState); }, [isOpen, initialData]);
      if (!isOpen) return null;

      const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
      const handleGeolocation = () => {
        if (!navigator.geolocation) { onShowNotification('error', "Geolocalización no soportada"); return; }
        setLocating(true);
        navigator.geolocation.getCurrentPosition(
          (pos) => { setFormData(prev => ({ ...prev, Lat: pos.coords.latitude, Lng: pos.coords.longitude })); setLocating(false); onShowNotification('success', "Ubicación obtenida"); },
          (err) => { onShowNotification('error', "Error de GPS"); setLocating(false); }
        );
      };
      const handleSubmit = async (e) => {
        e.preventDefault(); setLoading(true);
        try { await onSubmit(formData); onClose(); } catch (e) {} finally { setLoading(false); }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in">
          <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
              <h2 className="text-2xl font-bold text-slate-800">{initialData ? 'Editar Cliente' : 'Nuevo Cliente'}</h2>
              <button onClick={onClose} disabled={loading} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><XIcon className="w-6 h-6 text-slate-500" /></button>
            </div>
            <form onSubmit={handleSubmit} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Nombre *</label><input required name="Nombre" value={formData.Nombre} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Teléfono *</label><input required name="Teléfono" value={formData.Teléfono} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Email</label><input type="email" name="Email" value={formData.Email} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Empresa</label><input name="Empresa" value={formData.Empresa} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Cédula</label><input name="Cédula" value={formData.Cédula} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" /></div>
              <div className="md:col-span-2 space-y-2 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <label className="text-sm font-semibold text-slate-700 flex items-center gap-2"><MapPinIcon className="w-4 h-4 text-blue-500"/> Ubicación</label>
                <div className="flex gap-2 mb-2">
                  <input name="Dirección" value={formData.Dirección} onChange={handleChange} className="flex-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Dirección" />
                  <button type="button" onClick={handleGeolocation} disabled={locating} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 rounded-xl font-medium flex items-center gap-2 disabled:opacity-50">{locating ? '...' : <CrosshairIcon className="w-5 h-5" />} GPS</button>
                </div>
                <div className="text-xs font-mono text-slate-500 bg-slate-100 p-2 rounded-lg flex justify-between"><span>Lat: {formData.Lat?.toFixed(6) || '---'}</span><span>Lng: {formData.Lng?.toFixed(6) || '---'}</span></div>
              </div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Categoría</label><select name="Categoría" value={formData.Categoría} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl bg-white outline-none"><option>Cliente</option><option>Prospecto</option><option>Proveedor</option></select></div>
              <div className="space-y-2"><label className="text-sm font-semibold text-slate-700">Estado</label><select name="Estado" value={formData.Estado} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl bg-white outline-none"><option>Activo</option><option>Inactivo</option><option>Pendiente</option></select></div>
              <div className="md:col-span-2 space-y-2"><label className="text-sm font-semibold text-slate-700">Notas</label><textarea name="Notas" value={formData.Notas} onChange={handleChange} className="w-full p-3 border border-slate-200 rounded-xl min-h-[100px] outline-none" /></div>
              <div className="md:col-span-2 flex justify-end gap-4 mt-4 pt-4 border-t border-slate-100">
                <button type="button" onClick={onClose} disabled={loading} className="px-6 py-3 rounded-xl text-slate-600 hover:bg-slate-100">Cancelar</button>
                <button type="submit" disabled={loading} className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-blue-500/30 flex items-center gap-2 disabled:opacity-70">{loading ? '...' : <><SaveIcon className="w-5 h-5" /> Guardar</>}</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // --- 6. CONFIRM MODAL & APP (Similar to before) ---
    const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, isDeleting }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in">
          <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl border border-slate-100">
            <div className="flex items-center gap-3 mb-4 text-amber-500"><AlertTriangleIcon className="w-8 h-8" /><h3 className="text-xl font-bold text-slate-800">{title}</h3></div>
            <p className="text-slate-600 mb-6">{message}</p>
            <div className="flex justify-end gap-3">
              <button onClick={onClose} disabled={isDeleting} className="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 font-medium disabled:opacity-50">Cancelar</button>
              <button onClick={onConfirm} disabled={isDeleting} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-medium shadow-lg shadow-red-500/30 flex items-center gap-2 disabled:opacity-70">{isDeleting ? '...' : 'Confirmar'}</button>
            </div>
          </div>
        </div>
      );
    };

    function App() {
      const [clients, setClients] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingClient, setEditingClient] = useState(null);
      const [notification, setNotification] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [confirmModal, setConfirmModal] = useState({ isOpen: false, idToDelete: null, isDeleting: false });

      const showNotification = (type, message) => { setNotification({ type, message }); setTimeout(() => setNotification(null), 4000); };

      const loadData = useCallback(async () => {
        try { setLoading(true); const data = await fetchClients(); setClients(data); } 
        catch (e) { showNotification('error', e.message); } finally { setLoading(false); }
      }, []);

      useEffect(() => { loadData(); }, [loadData]);

      const handleSave = async (clientData) => {
        try { await saveClient(clientData); await loadData(); showNotification('success', clientData.ID ? 'Cliente actualizado' : 'Cliente creado'); } 
        catch (e) { showNotification('error', e.message); throw e; }
      };

      const requestDelete = (id) => { setConfirmModal({ isOpen: true, idToDelete: id, isDeleting: false }); };
      const confirmDelete = async () => {
        const id = confirmModal.idToDelete;
        if (!id) return;
        setConfirmModal(prev => ({ ...prev, isDeleting: true }));
        try { await deleteClient(id); setClients(prev => prev.filter(c => c.ID !== id)); showNotification('success', 'Cliente eliminado'); setConfirmModal({ isOpen: false, idToDelete: null, isDeleting: false }); } 
        catch (e) { showNotification('error', e.message); setConfirmModal(prev => ({ ...prev, isDeleting: false })); loadData(); }
      };

      const filteredClients = clients.filter(c => {
        const nombre = String(c.Nombre || '').toLowerCase();
        const empresa = String(c.Empresa || '').toLowerCase();
        const term = searchTerm.toLowerCase();
        return nombre.includes(term) || empresa.includes(term);
      });

      return (
        <div className="min-h-screen pb-20 relative">
          <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
              <div><h1 className="text-2xl font-extrabold bg-gradient-to-r from-blue-500 to-violet-500 bg-clip-text text-transparent">CRM Clientes</h1><p className="text-slate-500 text-xs">Gestión simple y geolocalizada</p></div>
              <button onClick={() => { setEditingClient(null); setIsModalOpen(true); }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl shadow-lg shadow-blue-600/20 font-semibold flex items-center gap-2 transition-all hover:scale-105 active:scale-95"><PlusIcon className="w-5 h-5" /> <span className="hidden sm:inline">Nuevo</span></button>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="mb-8 relative group">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><SearchIcon className="h-5 w-5 text-slate-400 group-focus-within:text-blue-500 transition-colors" /></div>
              <input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full pl-10 pr-3 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
            </div>

            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-100">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Cliente</th>
                      <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase hidden md:table-cell">Contacto</th>
                      <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase hidden lg:table-cell">Empresa</th>
                      <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Estado</th>
                      <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">Acciones</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-slate-100">
                    {loading ? (<tr><td colSpan={5} className="px-6 py-10 text-center text-slate-500 animate-pulse">Cargando...</td></tr>) : 
                     filteredClients.length === 0 ? (<tr><td colSpan={5} className="px-6 py-10 text-center text-slate-500">No hay datos. Asegúrate de haber configurado el script de Google Sheets.</td></tr>) : 
                     (filteredClients.map((client) => (
                        <tr key={client.ID} className="hover:bg-slate-50 transition-colors">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                              <div className="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg shadow-sm">{(client.Nombre || '?').toString().charAt(0).toUpperCase()}</div>
                              <div className="ml-4"><div className="text-sm font-semibold text-slate-900">{client.Nombre}</div><div className="text-xs text-slate-500 md:hidden">{client.Teléfono}</div></div>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap hidden md:table-cell"><div className="flex flex-col"><span className="text-sm text-slate-600 flex items-center gap-1"><PhoneIcon className="w-3 h-3 text-slate-400"/> {client.Teléfono}</span><span className="text-xs text-slate-400">{client.Email}</span></div></td>
                          <td className="px-6 py-4 whitespace-nowrap hidden lg:table-cell"><div className="flex items-center gap-2 text-sm text-slate-600"><Building2Icon className="w-4 h-4 text-slate-400"/> {client.Empresa || '-'}</div></td>
                          <td className="px-6 py-4 whitespace-nowrap"><span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${client.Estado === 'Activo' ? 'bg-green-100 text-green-700 border border-green-200' : client.Estado === 'Inactivo' ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-amber-100 text-amber-700 border border-amber-200'}`}>{client.Estado}</span></td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex items-center justify-end gap-2">
                              {client.Lat && client.Lng && (<a href={`https://www.google.com/maps/dir/?api=1&destination=${client.Lat},${client.Lng}`} target="_blank" className="text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 p-2 rounded-lg"><NavigationIcon className="w-4 h-4" /></a>)}
                              <button onClick={() => { setEditingClient(client); setIsModalOpen(true); }} className="text-amber-500 hover:text-amber-700 hover:bg-amber-50 p-2 rounded-lg"><Edit2Icon className="w-4 h-4" /></button>
                              <button onClick={() => requestDelete(client.ID)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg"><Trash2Icon className="w-4 h-4" /></button>
                            </div>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><MapPinIcon className="w-6 h-6 text-blue-500"/> Mapa</h2>
            <MapComponent clients={clients} tempLocation={editingClient?.Lat ? {lat: editingClient.Lat, lng: editingClient.Lng} : null} />
          </main>
          <ClientForm isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSubmit={handleSave} initialData={editingClient} onShowNotification={showNotification} />
          <ConfirmModal isOpen={confirmModal.isOpen} title="¿Eliminar?" message="Esta acción es irreversible." onClose={() => setConfirmModal({ isOpen: false, idToDelete: null, isDeleting: false })} onConfirm={confirmDelete} isDeleting={confirmModal.isDeleting} />
          {notification && (
            <div className={`fixed bottom-6 right-6 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-[70] animate-fade-in ${notification.type === 'success' ? 'bg-white border-l-4 border-emerald-500' : 'bg-white border-l-4 border-red-500'}`}>
              <div className={`w-2 h-2 rounded-full ${notification.type === 'success' ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
              <span className="font-medium text-slate-700">{notification.message}</span>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
